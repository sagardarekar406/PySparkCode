from pyspark.sql import SparkSession
from pyspark.sql.functions import (
    col, lower, when, count, avg, current_date, trim
)

# Jira: DATA-101 - Initialize Spark session for user data pipeline
spark = SparkSession.builder \
    .appName("UserDataProcessingPipeline") \
    .getOrCreate()

# Jira: DATA-102 - Read user data from source CSV
users_df = spark.read.csv(
    "/data/input/users.csv",
    header=True,
    inferSchema=True
)

# Jira: DATA-103 - Remove duplicate users based on user_id
users_df = users_df.dropDuplicates(["user_id"])

# Jira: DATA-104 - Filter out users with invalid age values
users_df = users_df.filter(
    (col("age").isNotNull()) & (col("age") > 0)
)

# Jira: DATA-105 - Trim whitespace from string columns
users_df = users_df.withColumn("email", trim(col("email"))) \
                   .withColumn("country", trim(col("country")))

# Jira: DATA-106 - Normalize email addresses to lowercase
users_df = users_df.withColumn(
    "email",
    lower(col("email"))
)

# Jira: DATA-107 - Add business rule to identify adult users
users_df = users_df.withColumn(
    "is_adult",
    when(col("age") >= 18, True).otherwise(False)
)

# Jira: DATA-108 - Enrich records with processing date
users_df = users_df.withColumn(
    "processed_date",
    current_date()
)

# Jira: DATA-109 - Aggregate user metrics by country
country_summary_df = users_df.groupBy("country").agg(
    count("*").alias("user_count"),
    avg("age").alias("average_age")
)

# Jira: DATA-110 - Persist aggregated output for downstream consumption
country_summary_df.write.mode("overwrite").parquet(
    "/data/output/country_user_summary"
)

spark.stop()
